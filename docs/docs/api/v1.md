# V1 接口 （基于 HTTP 和 WebSocket）

本文档描述了 Rabbit-Digger Pro 的 API v1 接口规范。

## 通用错误响应

当 API 调用发生错误时，会返回以下格式的错误信息：

```json
{
  "error": "错误信息描述"
}
```

状态码: 500

## 配置管理

### 获取当前配置

**GET** `/api/config`

获取当前运行的完整配置信息。

响应:

- Content-Type: application/json
- Body: 当前配置的 JSON 字符串，包含完整的运行时配置

### 更新配置

**POST** `/api/config`

更新并重启服务使用新的配置。

请求体:

```json
{
  "path": "配置文件路径",
  "poll": {
    "url": "配置URL",
    "interval": 更新间隔（可选）
  },
  "storage": {
    "folder": "存储文件夹",
    "key": "存储键名"
  },
  "text": "配置文本内容"
}
```

注意：请求体中的字段是可选的，根据配置来源选择相应的字段。

响应: `null`

## 系统信息

### 获取注册表信息

**GET** `/api/registry`

获取所有已注册的网络类型和服务器类型。

响应:

```json
{
  "net": {
    "<网络类型名称>": {
      "schema": "<JSON Schema>",
      "description": "网络类型描述"
    }
    // ... 其他网络类型
  },
  "server": {
    "<服务器类型名称>": {
      "schema": "<JSON Schema>",
      "description": "服务器类型描述"
    }
    // ... 其他服务器类型
  }
}
```

### 获取系统状态

**GET** `/api/state`

获取系统当前运行状态。

响应：系统状态字符串

## 连接管理

### 获取所有连接

**GET** `/api/connection`

获取当前所有活动连接的信息。

响应：

```json
{
  "connections": {
    "<连接UUID>": {
      "protocol": "<协议>",
      "addr": "<地址>",
      "upload": <上传字节数>,
      "download": <下载字节数>,
      "start_time": <开始时间戳>,
      "ctx": {
        "src_socket_addr": "<源地址>",
        "dest_domain": "<目标域名>",
        "net_list": ["<经过的网络列表>"]
      }
    }
  },
  "total_upload": <总上传字节数>,
  "total_download": <总下载字节数>
}
```

### 关闭所有连接

**DELETE** `/api/connection`

关闭所有活动的连接。

响应：返回已停止的连接信息，格式与 GET `/api/connection` 相同。

### 关闭指定连接

**DELETE** `/api/connection/{uuid}`

关闭特定 UUID 的连接。

参数:

- uuid: 连接的唯一标识符

响应:

```json
true  // 操作成功
false // 操作失败
```

### WebSocket 连接监控

**WebSocket** `/api/stream/connection?patch=<boolean>&without_connections=<boolean>`

通过 WebSocket 实时监控连接状态。

查询参数:

- patch: 是否使用增量更新模式
- without_connections: 是否排除详细连接信息

响应: 根据 patch 参数返回不同格式的 WebSocket 消息

当 patch=false 时:

```json
{
  "full": {
    "connections": {
      "<连接UUID>": {
        "protocol": "<协议>",
        "addr": "<地址>",
        "upload": <上传字节数>,
        "download": <下载字节数>,
        "start_time": <开始时间戳>,
        "ctx": {
          "src_socket_addr": "<源地址>",
          "dest_domain": "<目标域名>",
          "net_list": ["<经过的网络列表>"]
        }
      }
    },
    "total_upload": <总上传字节数>,
    "total_download": <总下载字节数>
  }
}
```

当 patch=true 时，首次返回完整数据，之后返回差异数据:

```json
{
  "patch": [
    { "op": "replace", "path": "/total_upload", "value": <新的上传字节数> },
    {
      "op": "add",
      "path": "/connections/<uuid>",
      "value": {
        /* 新增的连接信息 */
      }
    }
    // 其他 JSON Patch 操作
  ]
}
```

## 代理节点管理

### 更新代理选择

**POST** `/api/net/{net_name}`

更新 Select 类型代理的选择。

路径参数:

- net_name: 代理节点名称

请求体:

```json
{
  "selected": "选择的代理名称"
}
```

响应: `null`

### 测试延迟

**GET** `/api/net/{net_name}/delay?url={url}&timeout={timeout}`

测试指定代理节点的网络延迟。

路径参数:

- net_name: 代理节点名称

查询参数:

- url: 测试目标 URL
- timeout: 超时时间(毫秒)，默认 5000ms

响应:

```json
{
  "connect": 100, // 连接耗时(毫秒)
  "response": 200 // 响应耗时(毫秒)
}
```

如果测试超时或失败，返回：

```json
null
```

## 用户数据管理

### 获取用户数据

**GET** `/api/userdata/{path}`

获取指定路径的用户数据。

响应：存储的用户数据对象，格式取决于存储时的数据类型

### 设置用户数据

**PUT** `/api/userdata/{path}`

设置指定路径的用户数据。

响应：

```json
{
  "copied": 1024 // 成功写入的字节数
}
```

### 删除用户数据

**DELETE** `/api/userdata/{path}`

删除指定路径的用户数据。

响应：

```json
{
  "ok": true // 删除成功
}
```

### 列出所有用户数据

**GET** `/api/userdata`

获取所有用户数据的键列表。

响应:

```json
{
  "keys": [
    "key1",
    "key2"
    // ... 更多键
  ]
}
```

## 日志

### WebSocket 日志流

**WebSocket** `/api/stream/logs`

通过 WebSocket 实时接收系统日志。

响应：每个 WebSocket 消息包含一条日志记录的 JSON 对象，格式如下：

```json
{
  "timestamp": "2023-01-01T12:00:00Z",
  "level": "INFO",
  "message": "日志消息",
  "target": "目标模块",
  "fields": {
    "message": "详细信息",
    "ctx": "上下文JSON字符串",
    "parsedCtx": {
      "dest_socket_addr": "目标地址",
      "src_socket_addr": "源地址",
      "dest_domain": "目标域名",
      "net_list": ["经过的网络列表"]
    },
    "span": {
      "addr": "地址",
      "name": "名称",
      "self": "自身标识"
    },
    "spans": [
      {
        "addr": "地址",
        "name": "名称",
        "self": "自身标识"
      }
    ]
  }
}
```
